<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Prayer Tracker</title>

    <!-- Favicon Placeholder (matching the theme) -->
    <link rel="icon" type="image/x-icon" href="https://placehold.co/32x32/0d0d0d/00ff00?text=PRAY">

    <!-- Google Fonts: Inter for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom CSS for elements that can't be styled with Tailwind directly -->
    <style>
        /* Custom font family for the page */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Basic styling for the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #00FF00; /* Green from the theme */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-[#0D0D0D] text-[#00FF00] flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-4xl mx-auto text-center space-y-12 bg-[#1A1A1A] p-8 rounded-xl shadow-lg shadow-[#00FF00]/20 relative">
        <!-- Back to Home Button -->
        <button id="backToHomeBtn" class="absolute top-4 left-4 bg-transparent border border-[#00FF00] text-[#00FF00] hover:bg-[#00FF00] hover:text-[#0D0D0D] transition-colors duration-300 font-bold py-2 px-6 rounded-lg flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Home
        </button>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-2 mt-8">
            Community Prayer Tracker
        </h1>

        <p class="text-base sm:text-lg leading-relaxed text-gray-300">
            Click a button below to record your prayer. All prayers are visible to everyone.
        </p>

        <!-- Prayer Buttons Container -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
            <!-- Named Pray Button -->
            <button id="prayButton" class="bg-transparent border border-[#00FF00] text-[#00FF00] font-bold py-4 px-8 rounded-lg shadow-md hover:bg-[#00FF00] hover:text-[#0D0D0D] transform hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-[#00FF00]/50 active:scale-95 flex items-center justify-center">
                <svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                I Prayed!
                <div id="loadingSpinnerNamed" class="spinner ml-2 hidden"></div>
            </button>

            <!-- Anonymous Pray Button -->
            <button id="prayAnonymousButton" class="bg-transparent border border-gray-500 text-gray-400 font-bold py-4 px-8 rounded-lg shadow-md hover:bg-gray-500 hover:text-white transform hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-300/50 active:scale-95 flex items-center justify-center">
                <svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Pray Anonymously
                <div id="loadingSpinnerAnonymous" class="spinner ml-2 hidden"></div>
            </button>
        </div>

        <!-- Message Box for user feedback (global) -->
        <div id="messageBox" class="fixed top-5 left-1/2 -translate-x-1/2 py-2 px-5 rounded-lg shadow-lg z-50 transition-all duration-300 opacity-0 pointer-events-none">
            <span id="messageText"></span>
        </div>

        <!-- Anonymous Prayer Status Display -->
        <div class="bg-[#0D0D0D] p-4 rounded-lg border border-[#333333] text-gray-300 mb-8">
            <h3 class="text-xl font-bold mb-2 text-[#00FF00]">Anonymous Prayer Status</h3>
            <p id="anonymousStatusMessage" class="text-lg text-gray-400 mb-2 transition-opacity duration-500 opacity-0">
                <!-- "Someone just prayed anonymously!" message will appear here -->
            </p>
            <p class="text-md text-gray-400">
                Anonymous Prayers Today: <span id="anonymousPrayersTodayCount" class="font-bold text-[#00FF00]">0</span>
            </p>
        </div>

        <h2 class="text-2xl sm:text-3xl font-bold mb-4">
            Community Prayer History
        </h2>
        <!-- List of all saved prayer times -->
        <ul id="prayerHistoryList" class="text-left bg-[#0D0D0D] p-4 rounded-lg border border-[#333333] max-h-60 overflow-y-auto text-gray-300">
            <li class="text-gray-500">No community prayer times recorded yet.</li>
        </ul>

        <!-- Clear All Button -->
        <button id="clearAllButton" class="mt-6 bg-transparent border border-red-500 text-red-400 font-bold py-2 px-6 rounded-lg shadow-md hover:bg-red-500 hover:text-white transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-red-300/50 active:scale-95">
            Clear All Community Prayers
        </button>

        <p class="text-sm text-gray-500 mt-6">
            May your prayers bring you peace.
        </p>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Get app ID and Firebase config from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM elements
        const prayButton = document.getElementById('prayButton');
        const prayAnonymousButton = document.getElementById('prayAnonymousButton'); // New anonymous button
        const prayerHistoryList = document.getElementById('prayerHistoryList');
        const clearAllButton = document.getElementById('clearAllButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const loadingSpinnerNamed = document.getElementById('loadingSpinnerNamed'); // Spinner for named pray button
        const loadingSpinnerAnonymous = document.getElementById('loadingSpinnerAnonymous'); // Spinner for anonymous pray button
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const anonymousStatusMessage = document.getElementById('anonymousStatusMessage'); // New status message element
        const anonymousPrayersTodayCount = document.getElementById('anonymousPrayersTodayCount'); // New counter element

        // Function to show messages to the user (global feedback)
        function showMessage(message, type = 'info') {
            messageText.textContent = message;

            // Remove previous colors
            messageBox.classList.remove('bg-[#00FF00]', 'text-[#0D0D0D]', 'bg-[#FF0000]', 'text-[#0D0D0D]', 'bg-[#00FFFF]', 'text-[#0D0D0D]');
            messageBox.classList.add('pointer-events-auto'); // Make it clickable/visible

            if (type === 'success') {
                messageBox.classList.add('bg-[#00FF00]', 'text-[#0D0D0D]');
            } else if (type === 'error') {
                messageBox.classList.add('bg-[#FF0000]', 'text-[#0D0D0D]');
            } else { // info
                messageBox.classList.add('bg-[#00FFFF]', 'text-[#0D0D0D]');
            }

            // Show the message box
            messageBox.classList.remove('opacity-0');

            // Hide it after 3 seconds
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.classList.remove('pointer-events-auto');
            }, 3000);
        }

        // Function to show/hide loading spinner for a specific button
        function setLoading(buttonType, isLoading) {
            let spinner;
            let button;
            if (buttonType === 'named') {
                spinner = loadingSpinnerNamed;
                button = prayButton;
            } else if (buttonType === 'anonymous') {
                spinner = loadingSpinnerAnonymous;
                button = prayAnonymousButton;
            } else if (buttonType === 'clear') {
                button = clearAllButton;
            }

            if (isLoading) {
                if (spinner) spinner.classList.remove('hidden');
                button.disabled = true;
                // Keep other buttons enabled unless they are also performing an action
                if (buttonType !== 'clear') {
                    prayButton.disabled = true;
                    prayAnonymousButton.disabled = true;
                    clearAllButton.disabled = true;
                }
            } else {
                if (spinner) spinner.classList.add('hidden');
                button.disabled = false;
                // Re-enable all buttons after an action
                prayButton.disabled = false;
                prayAnonymousButton.disabled = false;
                clearAllButton.disabled = false;
            }
        }

        // Function to format the date and time
        function formatDateTime(date) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase initialized and authenticated. User ID:", userId);
                        // Load existing prayer times once authenticated
                        loadPrayerTimes();
                        loadAnonymousPrayerStatus(); // Load anonymous status as well
                    } else {
                        // Sign in anonymously if no user is logged in
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            showMessage("Error signing in. Please try again later.", 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Failed to initialize Firebase. Check console for details.", 'error');
            }
        }

        // Function to save a named prayer time to Firestore
        async function savePrayerTime() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait.", 'info');
                return;
            }
            setLoading('named', true);
            try {
                const now = new Date();
                const formattedTime = formatDateTime(now);

                const prayerCollectionRef = collection(db, `artifacts/${appId}/public/data/prayerTimes`);

                await addDoc(prayerCollectionRef, {
                    timestamp: now.getTime(),
                    formattedTime: formattedTime
                });

                showMessage("Prayer time saved successfully!", 'success');
            } catch (e) {
                console.error("Error adding named prayer document: ", e);
                showMessage("Failed to save prayer time. Please try again.", 'error');
            } finally {
                setLoading('named', false);
            }
        }

        // Function to save an anonymous prayer event to Firestore
        async function saveAnonymousPrayer() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait.", 'info');
                return;
            }
            setLoading('anonymous', true);
            try {
                const now = new Date();
                // We only need the timestamp for anonymous prayers for the counter
                const anonymousPrayerCollectionRef = collection(db, `artifacts/${appId}/public/data/anonymousPrayerEvents`);

                await addDoc(anonymousPrayerCollectionRef, {
                    timestamp: now.getTime()
                });

                showMessage("Anonymous prayer recorded!", 'success');
            } catch (e) {
                console.error("Error adding anonymous prayer document: ", e);
                showMessage("Failed to record anonymous prayer. Please try again.", 'error');
            } finally {
                setLoading('anonymous', false);
            }
        }

        // Function to load and display named prayer times from Firestore in real-time
        function loadPrayerTimes() {
            if (!isAuthReady) {
                console.log("Not ready to load named prayer times. Waiting for authentication.");
                return;
            }

            const prayerCollectionRef = collection(db, `artifacts/${appId}/public/data/prayerTimes`);
            onSnapshot(prayerCollectionRef, (snapshot) => {
                const prayerTimes = [];
                snapshot.forEach((doc) => {
                    prayerTimes.push({ id: doc.id, ...doc.data() });
                });

                prayerTimes.sort((a, b) => b.timestamp - a.timestamp); // Most recent first

                prayerHistoryList.innerHTML = ''; // Clear existing list

                if (prayerTimes.length === 0) {
                    prayerHistoryList.innerHTML = '<li class="text-gray-500">No community prayer times recorded yet.</li>';
                } else {
                    prayerTimes.forEach(prayer => {
                        const listItem = document.createElement('li');
                        listItem.className = 'py-2 border-b border-[#333333] last:border-b-0 text-gray-300';
                        listItem.textContent = prayer.formattedTime;
                        prayerHistoryList.appendChild(listItem);
                    });
                }
            }, (error) => {
                console.error("Error fetching named prayer times: ", error);
                showMessage("Error loading community prayer history. Please refresh.", 'error');
            });
        }

        // Function to load and display anonymous prayer status in real-time
        function loadAnonymousPrayerStatus() {
            if (!isAuthReady) {
                console.log("Not ready to load anonymous prayer status. Waiting for authentication.");
                return;
            }

            const anonymousPrayerCollectionRef = collection(db, `artifacts/${appId}/public/data/anonymousPrayerEvents`);
            onSnapshot(anonymousPrayerCollectionRef, (snapshot) => {
                const anonymousPrayers = [];
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime(); // Start of current day in milliseconds

                snapshot.forEach((doc) => {
                    const prayerTimestamp = doc.data().timestamp;
                    anonymousPrayers.push(prayerTimestamp);

                    // If it's a new prayer added *just now*, show the transient message
                    // This check is a bit simplistic; a more robust solution might involve server timestamps or a separate trigger
                    if (Math.abs(now.getTime() - prayerTimestamp) < 2000 && !doc.metadata.hasPendingWrites) {
                         // Only show message for newly added docs from other clients, not local writes instantly
                         // doc.metadata.hasPendingWrites is true for local writes before they commit to server
                        showAnonymousStatusMessage();
                    }
                });

                // Filter for today's prayers
                const todayAnonymousPrayers = anonymousPrayers.filter(timestamp => timestamp >= startOfDay);
                anonymousPrayersTodayCount.textContent = todayAnonymousPrayers.length;

            }, (error) => {
                console.error("Error fetching anonymous prayer events: ", error);
                showMessage("Error loading anonymous prayer status. Please refresh.", 'error');
            });
        }

        // Function to display the transient anonymous status message
        function showAnonymousStatusMessage() {
            anonymousStatusMessage.textContent = "Someone just prayed anonymously!";
            anonymousStatusMessage.classList.remove('opacity-0');
            setTimeout(() => {
                anonymousStatusMessage.classList.add('opacity-0');
            }, 3000); // Message fades out after 3 seconds
        }

        // Function to clear all public named prayer times
        async function clearAllPrayerTimes() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait.", 'info');
                return;
            }
            // Custom confirmation dialog
            const confirmClear = document.createElement('div');
            confirmClear.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmClear.innerHTML = `
                <div class="bg-[#1A1A1A] text-[#00FF00] p-6 rounded-lg shadow-xl text-center">
                    <p class="text-lg font-semibold mb-4">Are you sure you want to delete ALL community prayer times?</p>
                    <p class="text-sm text-gray-400 mb-6">This action cannot be undone and will clear the history for everyone.</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmYes" class="bg-transparent border border-red-500 text-red-400 px-4 py-2 rounded-md hover:bg-red-500 hover:text-white transition-colors duration-300">Yes, Clear All</button>
                        <button id="confirmNo" class="bg-transparent border border-[#00FF00] text-[#00FF00] px-4 py-2 rounded-md hover:bg-[#00FF00] hover:text-[#0D0D0D] transition-colors duration-300">No, Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmClear);

            document.getElementById('confirmYes').onclick = async () => {
                setLoading('clear', true); // Use 'clear' type for the spinner
                confirmClear.remove(); // Remove the confirmation dialog
                try {
                    const prayerCollectionRef = collection(db, `artifacts/${appId}/public/data/prayerTimes`);
                    const querySnapshot = await getDocs(prayerCollectionRef);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    showMessage("All community prayer times cleared successfully!", 'success');
                } catch (e) {
                    console.error("Error clearing documents: ", e);
                    showMessage("Failed to clear community prayer times. Please try again.", 'error');
                } finally {
                    setLoading('clear', false);
                }
            };

            document.getElementById('confirmNo').onclick = () => {
                confirmClear.remove(); // Remove the confirmation dialog
            };
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); // Initialize Firebase first
            prayButton.addEventListener('click', savePrayerTime);
            prayAnonymousButton.addEventListener('click', saveAnonymousPrayer); // New event listener for anonymous button
            clearAllButton.addEventListener('click', clearAllPrayerTimes);

            // Back to Home Button Event Listener
            if (backToHomeBtn) {
                backToHomeBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }
        });
    </script>
</body>
</html>

