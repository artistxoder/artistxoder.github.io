<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Prayer Tracker</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a clean look */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Basic styling for the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1; /* Tailwind indigo-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-200 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center transform transition-all duration-300 hover:scale-105">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2 tracking-tight">
            Community Prayer Tracker
        </h1>

        <p class="text-gray-600 mb-8 text-lg">
            Click the button below to record your prayer. All prayers are visible to everyone.
        </p>

        <!-- Pray Button -->
        <button id="prayButton" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300 active:scale-95 flex items-center justify-center mx-auto">
            <svg class="inline-block w-6 h-6 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            I Prayed!
            <div id="loadingSpinner" class="spinner ml-2 hidden"></div>
        </button>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="mt-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

        <!-- Display area for last prayer time (optional, as list shows all) -->
        <div id="lastPrayTimeDisplay" class="mt-8 text-xl font-semibold text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
            <!-- Last prayer time will be displayed here -->
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-4">
            Community Prayer History
        </h2>
        <!-- List of all saved prayer times -->
        <ul id="prayerHistoryList" class="text-left bg-gray-50 p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
            <li class="text-gray-500">No community prayer times recorded yet.</li>
        </ul>

        <!-- Clear All Button -->
        <button id="clearAllButton" class="mt-6 bg-red-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-red-600 transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-red-300 active:scale-95">
            Clear All Community Prayers
        </button>

        <p class="text-sm text-gray-500 mt-6">
            May your prayers bring you peace.
        </p>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        let app;
        let db;
        let auth;
        let userId; // Still needed for authentication, but not for data path
        let isAuthReady = false;

        // Get app ID and Firebase config from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM elements
        const prayButton = document.getElementById('prayButton');
        const lastPrayTimeDisplay = document.getElementById('lastPrayTimeDisplay');
        const prayerHistoryList = document.getElementById('prayerHistoryList');
        const clearAllButton = document.getElementById('clearAllButton');
        const messageBox = document.getElementById('messageBox');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Function to show messages to the user
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // Function to show/hide loading spinner
        function setLoading(isLoading) {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                prayButton.disabled = true;
                clearAllButton.disabled = true;
            } else {
                loadingSpinner.classList.add('hidden');
                prayButton.disabled = false;
                clearAllButton.disabled = false;
            }
        }

        // Function to format the date and time
        function formatDateTime(date) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // User ID is still set for authentication purposes
                        isAuthReady = true;
                        console.log("Firebase initialized and authenticated. User ID:", userId);
                        // Load existing prayer times once authenticated
                        loadPrayerTimes();
                    } else {
                        // Sign in anonymously if no user is logged in
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            showMessage("Error signing in. Please try again later.", 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Failed to initialize Firebase. Check console for details.", 'error');
            }
        }

        // Function to save a prayer time to Firestore
        async function savePrayerTime() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait.", 'info');
                return;
            }
            setLoading(true);
            try {
                const now = new Date();
                const formattedTime = formatDateTime(now);

                // Firestore collection path for PUBLIC data
                // Data is now saved to a shared collection visible to all users
                const prayerCollectionRef = collection(db, `artifacts/${appId}/public/data/prayerTimes`);

                await addDoc(prayerCollectionRef, {
                    timestamp: now.getTime(), // Store as Unix timestamp for sorting
                    formattedTime: formattedTime // Store formatted string for display
                });

                lastPrayTimeDisplay.textContent = `Last prayed on: ${formattedTime}`;
                lastPrayTimeDisplay.classList.remove('hidden');
                showMessage("Prayer time saved successfully!", 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to save prayer time. Please try again.", 'error');
            } finally {
                setLoading(false);
            }
        }

        // Function to load and display prayer times from Firestore in real-time
        function loadPrayerTimes() {
            if (!isAuthReady) {
                console.log("Not ready to load prayer times. Waiting for authentication.");
                return;
            }

            // Firestore collection path for PUBLIC data
            const prayerCollectionRef = collection(db, `artifacts/${appId}/public/data/prayerTimes`);
            // Use onSnapshot to get real-time updates
            onSnapshot(prayerCollectionRef, (snapshot) => {
                const prayerTimes = [];
                snapshot.forEach((doc) => {
                    prayerTimes.push({ id: doc.id, ...doc.data() });
                });

                // Sort the prayer times by timestamp in descending order (most recent first)
                prayerTimes.sort((a, b) => b.timestamp - a.timestamp);

                prayerHistoryList.innerHTML = ''; // Clear existing list

                if (prayerTimes.length === 0) {
                    prayerHistoryList.innerHTML = '<li class="text-gray-500">No community prayer times recorded yet.</li>';
                    lastPrayTimeDisplay.classList.add('hidden');
                } else {
                    prayerTimes.forEach(prayer => {
                        const listItem = document.createElement('li');
                        listItem.className = 'py-2 border-b border-gray-100 last:border-b-0 text-gray-700';
                        listItem.textContent = prayer.formattedTime;
                        prayerHistoryList.appendChild(listItem);
                    });
                    // Update the "last prayed" display with the most recent one
                    lastPrayTimeDisplay.textContent = `Last community prayer: ${prayerTimes[0].formattedTime}`;
                    lastPrayTimeDisplay.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Error fetching prayer times: ", error);
                showMessage("Error loading community prayer history. Please refresh.", 'error');
            });
        }

        // Function to clear all public prayer times
        async function clearAllPrayerTimes() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait.", 'info');
                return;
            }
            // Custom confirmation dialog
            const confirmClear = document.createElement('div');
            confirmClear.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmClear.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                    <p class="text-lg font-semibold mb-4">Are you sure you want to delete ALL community prayer times?</p>
                    <p class="text-sm text-gray-600 mb-6">This action cannot be undone and will clear the history for everyone.</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmYes" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Yes, Clear All</button>
                        <button id="confirmNo" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">No, Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmClear);

            document.getElementById('confirmYes').onclick = async () => {
                setLoading(true);
                confirmClear.remove(); // Remove the confirmation dialog
                try {
                    // Firestore collection path for PUBLIC data
                    const prayerCollectionRef = collection(db, `artifacts/${appId}/public/data/prayerTimes`);
                    const querySnapshot = await getDocs(prayerCollectionRef);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    showMessage("All community prayer times cleared successfully!", 'success');
                } catch (e) {
                    console.error("Error clearing documents: ", e);
                    showMessage("Failed to clear community prayer times. Please try again.", 'error');
                } finally {
                    setLoading(false);
                }
            };

            document.getElementById('confirmNo').onclick = () => {
                confirmClear.remove(); // Remove the confirmation dialog
            };
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); // Initialize Firebase first
            prayButton.addEventListener('click', savePrayerTime);
            clearAllButton.addEventListener('click', clearAllPrayerTimes);
        });
    </script>
</body>
</html>
